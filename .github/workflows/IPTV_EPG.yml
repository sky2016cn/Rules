name: Update IPTV_EPG

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 08:17ï¼ˆUTC 00:17ï¼‰
    - cron: '17 0 * * *'
  workflow_dispatch:

jobs:
  update-epg:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create IPTV_EPG directory
        run: mkdir -p IPTV_EPG

      - name: Download EPG files
        shell: bash
        run: |
          set -e

          download_file() {
            local url="$1"
            local output="$2"

            echo "â¡ï¸ å°è¯•ä¸‹è½½: $url"

            for attempt in 1 2; do
              echo "ç¬¬ $attempt æ¬¡å°è¯•..."
              if curl -A "Mozilla/5.0" -L "$url" \
                --connect-timeout 30 \
                --max-time 90 \
                -o "$output"; then

                if [ -s "$output" ]; then
                  echo "âœ… ä¸‹è½½æˆåŠŸ: $output ($(du -h "$output" | cut -f1))"
                  return 0
                else
                  echo "âš ï¸ æ–‡ä»¶ä¸ºç©ºï¼Œè§†ä¸ºå¤±è´¥"
                fi
              else
                echo "âš ï¸ ä¸‹è½½å¤±è´¥"
              fi

              [ "$attempt" -eq 1 ] && sleep 30
            done

            echo "âŒ ä¸‹è½½å½»åº•å¤±è´¥: $url"
            return 1
          }

          # ===== åœ¨è¿™é‡Œæ·»åŠ  / ä¿®æ”¹ EPG æº =====
          download_file "http://epg.51zmt.top:8000/e1.xml" "IPTV_EPG/e1.xml" || {
            echo "âŒ æœ¬æ¬¡ EPG ä¸‹è½½å½»åº•å¤±è´¥ï¼Œä¸è¿›è¡Œæ›´æ–°ï¼Œæœ¬æ¬¡ workflow å°†æ ‡è®°ä¸ºå¤±è´¥"
            exit 1
          }

          echo "ğŸ‰ æ‰€æœ‰ä¸‹è½½ä»»åŠ¡å®Œæˆ"

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          git add IPTV_EPG/

          if git diff --staged --quiet; then
            echo "ğŸ“­ æ–‡ä»¶æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "Update EPG $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "ğŸš€ æ›´æ–°å·²æ¨é€"
          fi

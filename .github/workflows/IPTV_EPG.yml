name: Update IPTV_EPG

on:
  schedule:
    # 每天，北京时间8:17点运行
    - cron: '17 0 * * *'
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create IPTV Directory
        run: mkdir -p IPTV_EPG

      - name: Download EPG File
        run: |
          # 1. 定义一个通用的下载函数
          download_file() {
            local url=$1
            local output=$2
            
            echo "正在尝试下载: $url"
            # 第一次尝试
            if curl -A "Mozilla/5.0" -L "$url" --connect-timeout 15 -o "$output"; then
              echo "✅ $output 下载成功！"
              return 0
            else
              echo "⚠️ $output 第一次失败，等待 10 分钟重试..."
              sleep 600
              # 第二次尝试
              if curl -A "Mozilla/5.0" -L "$url" --connect-timeout 15 -o "$output"; then
                echo "✅ $output 第二次下载成功！"
                return 0
              else
                echo "❌ $output 最终尝试失败。"
                return 1
              fi
            fi
          }

          # 2. 执行第一个文件的下载
          download_file "http://epg.51zmt.top:8000/e1.xml" "IPTV_EPG/e1.xml" || exit 1

          # 3. 如果你想添加“另一个源”，直接在这里照样加一行即可
          # download_file "http://另一个源地址" "IPTV_EPG/another.xml" || exit 1
          
          echo "所有下载任务已处理完毕。"

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          # 自动创建 IPTV 文件夹，如果已经存在，不再创建，再将 e1.xml 上传到 IPTV 文件夹内
          git add IPTV_EPG/e1.xml
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update EPG $(date +'%Y-%m-%d %H:%M')" && git push)
